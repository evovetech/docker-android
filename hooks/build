#!/bin/bash

source ${DOCKERFILE_PATH}/hooks/__env.sh

function _build() {
  local tag="$1"
  docker build \
    --build-arg "DOCKER_REPO=${DOCKER_REPO}" \
    --build-arg "BASE_IMAGE_TAG=${BASE_IMAGE_TAG}" \
    --build-arg "GRADLE_VERSION=${GRADLE_VERSION}" \
    --build-arg "GIT_REF=${GIT_REF}" \
    --build-arg "GIT_URL=${GIT_URL}" \
    --build-arg "DOCKER_CMD=${DOCKER_CMD}" \
    -t "${tag}" \
    .
}

# Create base image
IMAGES="${DOCKERFILE_PATH}/images"
cd ${IMAGES}/base
_build "${DOCKER_REPO}:base.${BASE_IMAGE_TAG}"
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi

# Create gradle image
cd ${IMAGES}/gradle
_build "${DOCKER_REPO}:gradle.${GRADLE_VERSION}"
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi

# Create main image
cd ${DOCKERFILE_PATH}
_build "${DOCKER_REPO}:${CACHE_TAG}"
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi
