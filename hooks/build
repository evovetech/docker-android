#!/bin/bash

GIT_REF="$( git rev-parse --short HEAD)"
GIT_URL="https://github.com/evovetech/docker-android"

function _build() {
  local tag="$1"
  docker build \
    --build-arg "GIT_REF=${GIT_REF}" \
    --build-arg "GIT_URL=${GIT_URL}" \
    -t "${tag}" \
    .
}

# Create base image
cd base
_build "${DOCKER_REPO}:base.${CACHE_TAG}"
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi

# Create gradle image
cd ../gradle
_build "${DOCKER_REPO}:gradle.${CACHE_TAG}" .
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi

# Create main image
cd ../main
_build "${DOCKER_REPO}:${CACHE_TAG}" .
st=$?
if [[ $st -ne 0 ]]; then
  exit $st
fi
